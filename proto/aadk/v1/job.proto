syntax = "proto3";
package aadk.v1;

import "aadk/v1/common.proto";
import "aadk/v1/errors.proto";

enum JobState {
  JOB_STATE_UNSPECIFIED = 0;
  JOB_STATE_QUEUED = 1;
  JOB_STATE_RUNNING = 2;
  JOB_STATE_SUCCESS = 3;
  JOB_STATE_FAILED = 4;
  JOB_STATE_CANCELLED = 5;
}

message JobRef {
  Id job_id = 1;
}

message Job {
  Id job_id = 1;
  string job_type = 2;
  JobState state = 3;
  Timestamp created_at = 4;
  Timestamp started_at = 5;
  Timestamp finished_at = 6;
  string display_name = 7;
  string correlation_id = 8;
  RunId run_id = 12;

  // Optional linkage
  Id project_id = 9;
  Id target_id = 10;
  Id toolchain_set_id = 11;
}

message JobProgress {
  uint32 percent = 1;
  string phase = 2;
  repeated KeyValue metrics = 3;
}

message LogChunk {
  string stream = 1;
  bytes data = 2;
  bool truncated = 3;
}

message JobEvent {
  Timestamp at = 1;
  Id job_id = 2;

  oneof payload {
    JobStateChanged state_changed = 10;
    JobProgressUpdated progress = 11;
    JobLogAppended log = 12;
    JobCompleted completed = 13;
    JobFailed failed = 14;
  }
}

message JobStateChanged {
  JobState new_state = 1;
}

message JobProgressUpdated {
  JobProgress progress = 1;
}

message JobLogAppended {
  LogChunk chunk = 1;
}

message JobCompleted {
  string summary = 1;
  repeated KeyValue outputs = 2;
}

message JobFailed {
  ErrorDetail error = 1;
}

enum JobEventKind {
  JOB_EVENT_KIND_UNSPECIFIED = 0;
  JOB_EVENT_KIND_STATE_CHANGED = 1;
  JOB_EVENT_KIND_PROGRESS = 2;
  JOB_EVENT_KIND_LOG = 3;
  JOB_EVENT_KIND_COMPLETED = 4;
  JOB_EVENT_KIND_FAILED = 5;
}

message JobFilter {
  repeated string job_types = 1;
  repeated JobState states = 2;
  Timestamp created_after = 3;
  Timestamp created_before = 4;
  Timestamp finished_after = 5;
  Timestamp finished_before = 6;
  string correlation_id = 7;
  RunId run_id = 8;
}

message JobHistoryFilter {
  repeated JobEventKind kinds = 1;
  Timestamp after = 2;
  Timestamp before = 3;
}

message StartJobRequest {
  string job_type = 1;
  repeated KeyValue params = 2;
  Id project_id = 3;
  Id target_id = 4;
  Id toolchain_set_id = 5;
  string correlation_id = 6;
  RunId run_id = 7;
}

message StartJobResponse {
  JobRef job = 1;
}

message GetJobRequest {
  Id job_id = 1;
}

message GetJobResponse {
  Job job = 1;
}

message CancelJobRequest {
  Id job_id = 1;
}

message CancelJobResponse {
  bool accepted = 1;
}

message StreamJobEventsRequest {
  Id job_id = 1;
  bool include_history = 2;
}

message StreamRunEventsRequest {
  RunId run_id = 1;
  string correlation_id = 2;
  bool include_history = 3;
  uint32 buffer_max_events = 4;
  uint64 max_delay_ms = 5;
  uint64 discovery_interval_ms = 6;
}

message PublishJobEventRequest {
  JobEvent event = 1;
}

message PublishJobEventResponse {
  bool accepted = 1;
}

message ListJobsRequest {
  Pagination page = 1;
  JobFilter filter = 2;
}

message ListJobsResponse {
  repeated Job jobs = 1;
  PageInfo page_info = 2;
}

message ListJobHistoryRequest {
  Id job_id = 1;
  Pagination page = 2;
  JobHistoryFilter filter = 3;
}

message ListJobHistoryResponse {
  repeated JobEvent events = 1;
  PageInfo page_info = 2;
}

service JobService {
  rpc StartJob(StartJobRequest) returns (StartJobResponse);
  rpc GetJob(GetJobRequest) returns (GetJobResponse);
  rpc CancelJob(CancelJobRequest) returns (CancelJobResponse);
  rpc StreamJobEvents(StreamJobEventsRequest) returns (stream JobEvent);
  rpc StreamRunEvents(StreamRunEventsRequest) returns (stream JobEvent);
  rpc PublishJobEvent(PublishJobEventRequest) returns (PublishJobEventResponse);
  rpc ListJobs(ListJobsRequest) returns (ListJobsResponse);
  rpc ListJobHistory(ListJobHistoryRequest) returns (ListJobHistoryResponse);
}
