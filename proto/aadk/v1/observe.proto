syntax = "proto3";
package aadk.v1;

import "aadk/v1/common.proto";

message RunRecord {
  RunId run_id = 1;
  Id project_id = 2;
  Id target_id = 3;
  Id toolchain_set_id = 4;
  Timestamp started_at = 5;
  Timestamp finished_at = 6;
  string result = 7;
  repeated Id job_ids = 8;
  repeated KeyValue summary = 9;
  string correlation_id = 10;
  RunOutputSummary output_summary = 11;
}

enum RunOutputKind {
  RUN_OUTPUT_KIND_UNSPECIFIED = 0;
  RUN_OUTPUT_KIND_BUNDLE = 1;
  RUN_OUTPUT_KIND_ARTIFACT = 2;
}

message RunOutputSummary {
  uint32 bundle_count = 1;
  uint32 artifact_count = 2;
  Timestamp updated_at = 3;
  string last_bundle_id = 4;
}

message RunOutput {
  string output_id = 1;
  RunId run_id = 2;
  RunOutputKind kind = 3;
  string output_type = 4;
  string path = 5;
  string label = 6;
  Id job_id = 7;
  Timestamp created_at = 8;
  repeated KeyValue metadata = 9;
}

message RunOutputFilter {
  RunOutputKind kind = 1;
  string output_type = 2;
  string path_contains = 3;
  string label_contains = 4;
}

message ListRunOutputsRequest {
  RunId run_id = 1;
  Pagination page = 2;
  RunOutputFilter filter = 3;
}
message ListRunOutputsResponse {
  repeated RunOutput outputs = 1;
  PageInfo page_info = 2;
  RunOutputSummary summary = 3;
}

message UpsertRunOutputsRequest {
  RunId run_id = 1;
  repeated RunOutput outputs = 2;
}
message UpsertRunOutputsResponse { RunOutputSummary summary = 1; }

message RunFilter {
  RunId run_id = 1;
  string correlation_id = 2;
  Id project_id = 3;
  Id target_id = 4;
  Id toolchain_set_id = 5;
  string result = 6;
}

message ListRunsRequest { Pagination page = 1; RunFilter filter = 2; }
message ListRunsResponse { repeated RunRecord runs = 1; PageInfo page_info = 2; }

message ExportSupportBundleRequest {
  bool include_logs = 1;
  bool include_config = 2;
  bool include_toolchain_provenance = 3;
  bool include_recent_runs = 4;
  uint32 recent_runs_limit = 5;
  Id job_id = 6;
  Id project_id = 7;
  Id target_id = 8;
  Id toolchain_set_id = 9;
  string correlation_id = 10;
  RunId run_id = 11;
}
message ExportSupportBundleResponse { Id job_id = 1; string output_path = 2; }

message ExportEvidenceBundleRequest { RunId run_id = 1; Id job_id = 2; string correlation_id = 3; }
message ExportEvidenceBundleResponse { Id job_id = 1; string output_path = 2; }

message UpsertRunRequest {
  RunId run_id = 1;
  string correlation_id = 2;
  Id project_id = 3;
  Id target_id = 4;
  Id toolchain_set_id = 5;
  repeated Id job_ids = 6;
  string result = 7;
  repeated KeyValue summary = 8;
  Timestamp started_at = 9;
  Timestamp finished_at = 10;
}
message UpsertRunResponse { RunRecord run = 1; }

service ObserveService {
  rpc ListRuns(ListRunsRequest) returns (ListRunsResponse);
  rpc ListRunOutputs(ListRunOutputsRequest) returns (ListRunOutputsResponse);
  rpc ExportSupportBundle(ExportSupportBundleRequest) returns (ExportSupportBundleResponse);
  rpc ExportEvidenceBundle(ExportEvidenceBundleRequest) returns (ExportEvidenceBundleResponse);
  rpc UpsertRun(UpsertRunRequest) returns (UpsertRunResponse);
  rpc UpsertRunOutputs(UpsertRunOutputsRequest) returns (UpsertRunOutputsResponse);
  rpc ReloadState(ReloadStateRequest) returns (ReloadStateResponse);
}
